#!/bin/bash

# make notes to obsidian with dmenu support and image recognition for clipboard content
# dependencies: xclip notify-send

entrypath="$KB_DIRECTORY/main/Notes/"
subfolder="Unsorted"
attachements="_attachments"
mimetype='image/png'

# terminal or system call?
[ -t 1 ] && [ "$TERM" != 'linux' ] &&
	terminal=true

# use arguments or dmenu prompt for note content?
[[ -n $terminal ]] &&
	content="$@" ||
	content=$(dmenu < /dev/null)

nowdate=$(date +"%Y-%m-%d");
nowtime=$(date +"%H-%M-%S");

# declare rather image is available and of what source (clipboard or temporary dir)
[[ $(xclip -selection clipboard -t TARGETS -o | grep "$mimetype") ]] &&
	isclp=true
[[ -z $image ]] && [[ -f /tmp/unsorted ]] &&
	istmp=true
[[ -z $isclp ]] && [[ -z $istmp ]] || image=true

# if clipboard content or /tmp/unsorted has image information then write it to attachments folder
# and clear clipboard from image content for not to be used again in the next note
if [[ -n $image ]]; then
	[[ -n $content ]] && 
		imagename="$attachements/$nowdate $content.png" ||
		imagename="$attachements/$nowdate-$nowtime.png"

	fullimagepath="$entrypath/$subfolder/$imagename"

	[[ -n $image ]] && \
		echo "![[$imagename]]" >> "$entrypath/$subfolder/todos.md"

	mkdir -p "$entrypath/$subfolder/$attachements"
	[[ -n $isclp ]] &&
		xclip -selection clipboard -t $mimetype -o > "$fullimagepath" &&
		xclip -selection clipboard < /dev/null
	[[ -n $istmp ]] && 
		mv /tmp/unsorted "$fullimagepath"
fi

# if neither text nor image set, open vim for editing manually
# else if text contains link then create new note with link to be scraped
# else if only text is set then insert checkbox with text
if [[ -z $content ]] && [[ -z $image ]]; then
	nvim "$entrypath/$subfolder/todos.md"
elif [[ $content =~ ^https://.* ]]; then
	echo $"- Scrap [$content]" >> "$entrypath/$subfolder/$nowdate.md" &&
		finish=true
elif [[ -z $content ]]; then
	echo $"-[ ] $content" >> "$entrypath/$subfolder/todos.md" && 
		finish=true
fi

# if image exists then add markdown embeding
[[ -n $fullimagepath ]] && [[ -f $fullimagepath ]] &&
	echo "![[$imagename]]" >> "$entrypath/$subfolder/todos.md" &&
	finish=true

if [[ -n $finish ]]; then
	msg="Unsorted entry made"
	[[ -n $terminal ]] &&
		echo "$msg" || notify-send "$msg"
else
	notify-send "something went wrong"
fi
