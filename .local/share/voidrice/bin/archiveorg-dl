#!/usr/bin/env bash

[[ -z $(which xmlstarlet 2>/dev/null) ]] && error "command xmlstarlet not installed"
[[ -n $1 ]] && aid="$1" || aid="$(xclip -selection clipboard -o -print0)"
url="https://archive.org/services/loans/loan/?action=media_url&identifier=$aid&format=pdf&redirect=1"
acsmfile="$HOME/Downloads/URLLink.acsm"
echo "Opening URL $url" && xdg-open "$url" > /dev/null 2>&1 & disown

printf "Now put the URLLink.acsm file into your ~/Downloads directory"
until [ -f "$acsmfile" ]
do
     sleep 1
     printf "%0.s."
done && echo "found"

booktitle=`xmlstarlet sel -t -v '//*[local-name()="title"][text()]' -nl "$acsmfile"`
destination="$HOME/Documents/$booktitle.pdf"

knock "$acsmfile" && 
	mv -iv "${acsmfile/.acsm/.pdf}" "$destination" &&
	rm -f "$acsmfile"
